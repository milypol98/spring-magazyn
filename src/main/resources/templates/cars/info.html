<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pl">
<head>
    <meta charset="UTF-8" />
    <title>Szczegóły pojazdu</title>
    <link rel="stylesheet" th:href="@{/css/general.css}" />
</head>
<body>

<header class="page-header">
    <nav class="breadcrumbs" aria-label="breadcrumb">
        <a th:href="@{/dashboard}" class="crumb">Strona główna</a>
        <span class="sep">/</span>
        <a th:href="@{/cars}" class="crumb">Pojazdy</a>
        <span class="sep">/</span>
        <span class="crumb current">Szczegóły</span>
    </nav>
    <div class="header-row">
        <h1 class="page-title">Szczegóły pojazdu</h1>
        <div class="header-tools">
            <a th:href="@{/cars/cost/add/{carId}(carId=${car.id})}" class="btn btn-primary">+ Dodaj koszt</a>
        </div>
    </div>
</header>

<main class="content">
    <section class="card">
        <div class="details-grid">
            <div class="detail">
                <div class="label">Nazwa</div>
                <div class="value" th:text="${#strings.defaultString(car.name,'—')}">Moje Auto</div>
            </div>
            <div class="detail">
                <div class="label">Rejestracja</div>
                <div class="value" th:text="${#strings.defaultString(car.registration,'—')}">SK 12345</div>
            </div>
            <div class="detail">
                <div class="label">VIN</div>
                <div class="value" th:text="${#strings.defaultString(car.vin,'—')}">ABC...</div>
            </div>
            <div class="detail">
                <div class="label">Marka</div>
                <div class="value" th:text="${#strings.defaultString(car.brand,'—')}">Ford</div>
            </div>
            <div class="detail">
                <div class="label">Model</div>
                <div class="value" th:text="${#strings.defaultString(car.model,'—')}">Focus</div>
            </div>
            <div class="detail">
                <div class="label">Rok produkcji</div>
                <div class="value" th:text="${car.year != null ? #temporals.format(car.year, 'yyyy') : '—'}">2020</div>
            </div>
            <div class="detail">
                <div class="label">Kolor</div>
                <div class="value" th:text="${#strings.defaultString(car.color,'—')}">Niebieski</div>
            </div>
            <div class="detail">
                <div class="label">Właściciel</div>
                <div class="value" th:text="${#strings.defaultString(car.owner,'—')}">Jan Kowalski</div>
            </div>
            <div class="detail">
                <div class="label">Poj. silnika</div>
                <div class="value" th:text="${#strings.defaultString(car.engineCapacity,'—')}">1.5</div>
            </div>

            <div class="detail">
                <div class="label">Aktualny przebieg</div>
                <div class="value" th:text="${car.course != null ? car.course + ' km' : '—'}">150 000 km</div>
            </div>
            <div class="detail">
                <div class="label">Przebieg z dnia</div>
                <div class="value" th:text="${car.courseDate != null ? #temporals.format(car.courseDate, 'dd.MM.yyyy') : '—'}">01.10.2025</div>
            </div>

            <div class="detail" th:if="${car.review != null}">
                <div class="label">Przegląd techniczny</div>
                <div class="value"
                     th:with="daysRemaining=${T(java.time.temporal.ChronoUnit).DAYS.between(T(java.time.LocalDate).now(), car.review)}"
                     th:text="|${#temporals.format(car.review, 'dd.MM.yyyy')} (${daysRemaining >= 0 ? 'zostało ' + daysRemaining : 'po terminie ' + -daysRemaining} dni)|"
                     th:classappend="${daysRemaining <= car.reviewCriticalDay} ? 'status-critical' : (${daysRemaining <= car.reviewWarningDay} ? 'status-warning' : '')">
                </div>
            </div>

            <div class="detail" th:if="${car.insured != null}">
                <div class="label">Ubezpieczenie OC</div>
                <div class="value"
                     th:with="daysRemaining=${T(java.time.temporal.ChronoUnit).DAYS.between(T(java.time.LocalDate).now(), car.insured)}"
                     th:text="|${#temporals.format(car.insured, 'dd.MM.yyyy')} (${daysRemaining >= 0 ? 'zostało ' + daysRemaining : 'po terminie ' + -daysRemaining} dni)|"
                     th:classappend="${daysRemaining <= car.insuredCriticalDay} ? 'status-critical' : (${daysRemaining <= car.insuredWarningDay} ? 'status-warning' : '')">
                </div>
            </div>

            <div class="detail" th:if="${car.tiresCheck != null}">
                <div class="label">Kontrola opon</div>
                <div class="value"
                     th:with="daysRemaining=${T(java.time.temporal.ChronoUnit).DAYS.between(T(java.time.LocalDate).now(), car.tiresCheck)}"
                     th:text="|${#temporals.format(car.tiresCheck, 'dd.MM.yyyy')} (${daysRemaining >= 0 ? 'zostało ' + daysRemaining : 'po terminie ' + -daysRemaining} dni)|"
                     th:classappend="${daysRemaining <= car.tiresCheckCriticalDay} ? 'status-critical' : (${daysRemaining <= car.tiresCheckWarningDay} ? 'status-warning' : '')">
                </div>
            </div>

            <div class="detail" th:if="${car.oilChangeCourse != null and car.oilChangeIntervalKm != null and car.course != null}">
                <div class="label">Wymiana oleju</div>
                <div class="value"
                     th:with="nextServiceKm=${car.oilChangeCourse + car.oilChangeIntervalKm}, kmRemaining=${(car.oilChangeCourse + car.oilChangeIntervalKm) - car.course}"
                     th:text="|przy ${#numbers.formatInteger(nextServiceKm, 0, 'WHITESPACE')} km (${kmRemaining >= 0 ? 'zostało ' + #numbers.formatInteger(kmRemaining, 0, 'WHITESPACE') : 'przekroczono o ' + #numbers.formatInteger(-kmRemaining, 0, 'WHITESPACE')} km)|"
                     th:classappend="${kmRemaining <= car.oilChangeIntervalKmCritical} ? 'status-critical' : (${kmRemaining <= car.oilChangeIntervalKmWarning} ? 'status-warning' : '')">
                </div>
            </div>

            <div class="detail" th:if="${car.timingSystemCourse != null and car.timingSystemIntervalKm != null and car.course != null}">
                <div class="label">Wymiana rozrządu</div>
                <div class="value"
                     th:with="nextServiceKm=${car.timingSystemCourse + car.timingSystemIntervalKm}, kmRemaining=${(car.timingSystemCourse + car.timingSystemIntervalKm) - car.course}"
                     th:text="|przy ${#numbers.formatInteger(nextServiceKm, 0, 'WHITESPACE')} km (${kmRemaining >= 0 ? 'zostało ' + #numbers.formatInteger(kmRemaining, 0, 'WHITESPACE') : 'przekroczono o ' + #numbers.formatInteger(-kmRemaining, 0, 'WHITESPACE')} km)|"
                     th:classappend="${kmRemaining <= car.timingSystemKmCritical} ? 'status-critical' : (${kmRemaining <= car.timingSystemKmWarning} ? 'status-warning' : '')">
                </div>
            </div>



            <div class="detail" th:if="${car.reminderDate != null}">
                <div class="label" th:text="${#strings.defaultString(car.reminderDateDescription, 'Przypomnienie')}"></div>
                <div class="value"
                     th:with="daysRemaining=${T(java.time.temporal.ChronoUnit).DAYS.between(T(java.time.LocalDate).now(), car.reminderDate)}"
                     th:text="|${#temporals.format(car.reminderDate, 'dd.MM.yyyy')} (${daysRemaining >= 0 ? 'zostało ' + daysRemaining : 'po terminie ' + -daysRemaining} dni)|"
                     th:classappend="${daysRemaining <= car.reminderDateCriticalDay} ? 'status-critical' : (${daysRemaining <= car.reminderDateWarningDay} ? 'status-warning' : '')">
                </div>
            </div>

            <div class="detail" th:if="${car.reminderKm != null and car.course != null}">
                <div class="label" th:text="${#strings.defaultString(car.reminderKmDescription, 'Przypomnienie')}"></div>
                <div class="value"
                     th:with="kmRemaining=${car.reminderKm - car.course}"
                     th:text="|przy ${#numbers.formatInteger(car.reminderKm, 0, 'WHITESPACE')} km (${kmRemaining >= 0 ? 'zostało ' + #numbers.formatInteger(kmRemaining, 0, 'WHITESPACE') : 'przekroczono o ' + #numbers.formatInteger(-kmRemaining, 0, 'WHITESPACE')} km)|"
                     th:classappend="${kmRemaining <= car.reminderKmCritical} ? 'status-critical' : (${kmRemaining <= car.reminderKmWarning} ? 'status-warning' : '')">
                </div>
            </div>

            <div class="detail wide" th:if="${not #strings.isEmpty(car.description)}">
                <div class="label">Opis</div>
                <div class="value" th:text="${car.description}">Dodatkowe informacje o samochodzie.</div>
            </div>
        </div>
    </section>

    <!-- Karta: koszty pojazdu -->
    <section class="card">
        <div class="table-header">
            <label class="table-title">Koszty pojazdu</label>
            <input type="search"
                   class="table-search"
                   placeholder="Szukaj..."
                   data-target-table="#carsCostTable"
                   data-sum-columns="4:carSum,5:invCarSumNet">
        </div>

        <div class="table-wrapper">
            <table id="carsCostTable" class="table">
                <thead>
                <tr>
                    <th>L.P.</th>
                    <th>Data od</th>
                    <th>Data do</th>
                    <th>Opis</th>
                    <th>Kwota(Netto) z faktury</th>
                    <th>Cena</th>
                    <th>Akcje</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="c, i : ${car.costs}">
                    <td th:text="${i.index + 1}"></td>
                    <td th:text="${c.dateFrom}"></td>
                    <td th:text="${c.dateTo}"></td>
                    <td th:text="${#strings.defaultString(c.description,'—')}"></td>
                    <td>
                        <span th:if="${c.invoice != null}" th:text="${#numbers.formatDecimal(c.invoice.totalNet, 1, 'POINT', 2, 'COMMA')}"></span>
                        <span th:unless="${c.invoice != null}">—</span>
                    </td>
                    <td th:text="${c.cost}"></td>
                    <td class="actions">
                        <a class="btn btn-small" th:href="@{/cars/cost/edit/{id}(id=${c.id})}">Edytuj</a>
                        <form th:action="@{/cars/cost/delete/{id}(id=${c.id})}" method="post" class="inline-form" data-confirm="Usunąć ten koszt?">
                            <input type="hidden" name="carId" th:value="${car.id}" />
                            <button type="submit" class="btn btn-danger btn-small">Usuń</button>
                        </form>
                    </td>
                </tr>
                <tfoot th:if="${!#lists.isEmpty(car.costs)}">
                <tr>
                    <td colspan="4" class="text-right"><strong>Suma</strong></td>
                    <td id="carSum"></td>
                    <td id="invCarSumNet"></td>
                </tr>
                </tfoot>
                <tr th:if="${#lists.isEmpty(car.costs)}">
                    <td colspan="5">Brak kosztów dla tego pojazdu.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>
</main>

<script th:src="@{/js/general.js}"></script>
</body>
</html>