<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pl">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" th:href="@{/css/general.css}" />
    <style>
        .hidden { display: none !important; }
        .field-group { margin: 8px 0; }
        label.inline { margin-right: 8px; }
        .w200 { width: 200px; }
    </style>
</head>
<body>
<h1>
    <div th:replace="~{fragments/navBar :: navbar}"></div>
</h1>

<div class="top-row">
    <div class="side-by-side">
        <div class="container w1200">
            <div class="table-header">
                <label class="table-title" th:text="|Produkt: ${product.name}|"></label>
            </div>

            <!-- Jeden endpoint dla wszystkich typów zdarzeń -->
            <form th:action="@{'/events/product-event/save'}" th:object="${productEvent}" method="post" id="eventForm">
                <input type="hidden" th:field="*{id}" />
                <input type="hidden" th:field="*{product.id}" />

                <div class="field-group">
                    <label class="inline">Ilość</label>
                    <input type="number" th:field="*{quantity}" class="w200" required />
                </div>

                <div class="field-group" id="grp-unitPrice">
                    <label class="inline">Cena jednostkowa</label>
                    <input type="number" step="0.01" th:field="*{unitPrice}" class="w200" />
                </div>

                <div class="field-group">
                    <label class="inline">Komentarz</label>
                    <textarea th:field="*{comment}" class="w200"></textarea>
                </div>

                <div class="field-group">
                    <label class="inline">Data i czas</label>
                    <input type="datetime-local" th:field="*{timestamp}"
                           th:text="${#temporals.format(productEvent.timestamp, 'yyyy-MM-dd''T''HH:mm')}" required />
                </div>

                <!-- Typ zdarzenia -->
                <div class="field-group" id="grp-eventType">
                    <label class="inline">Typ</label>
                    <select th:field="*{eventType}" id="eventType" required>
                        <option value="" disabled selected>-- wybierz typ zdarzenia --</option>
                        <option th:each="t : ${eventTypes}" th:value="${t}" th:text="${t}"></option>
                    </select>
                </div>

                <!-- FROM -->
                <div class="field-group" id="grp-fromType">
                    <label class="inline">Źródło (From)</label>
                    <select th:field="*{fromLocationType}" id="fromType">
                        <option value="" disabled selected>-- wybierz typ źródła --</option>
                        <option th:each="l : ${locationTypes}" th:value="${l}" th:text="${l}"></option>
                    </select>
                </div>

                <div class="field-group" id="grp-fromCar">
                    <label class="inline">Auto źródłowe</label>
                    <select th:field="*{fromLocationCode}" id="fromCar">
                        <option value="" disabled selected>-- wybierz auto --</option>
                        <option th:each="c : ${cars}" th:value="${c.id}"
                                th:text="${c.name + ' | ' + (c.registration ?: '')}"></option>
                    </select>
                </div>

                <div class="field-group" id="grp-fromTask">
                    <label class="inline">Zadanie źródłowe</label>
                    <select th:field="*{fromLocationCode}" id="fromTask">
                        <option value="" disabled selected>-- wybierz zadanie --</option>
                        <option th:each="t : ${tasks}" th:value="${t.id}" th:text="${t.name}"></option>
                    </select>
                </div>

                <!-- TO -->
                <div class="field-group" id="grp-toType">
                    <label class="inline">Cel (To)</label>
                    <select th:field="*{toLocationType}" id="toType">
                        <option value="" disabled selected>-- wybierz typ celu --</option>
                        <option th:each="l : ${locationTypes}" th:value="${l}" th:text="${l}"></option>
                    </select>
                </div>

                <div class="field-group" id="grp-toCar">
                    <label class="inline">Auto docelowe</label>
                    <select th:field="*{toLocationCode}" id="toCar">
                        <option value="" disabled selected>-- wybierz auto --</option>
                        <option th:each="c : ${cars}" th:value="${c.id}"
                                th:text="${c.name + ' | ' + (c.registration ?: '')}"></option>
                    </select>
                </div>

                <div class="field-group" id="grp-toTask">
                    <label class="inline">Zadanie docelowe</label>
                    <select th:field="*{toLocationCode}" id="toTask">
                        <option value="" disabled selected>-- wybierz zadanie --</option>
                        <option th:each="t : ${tasks}" th:value="${t.id}" th:text="${t.name}"></option>
                    </select>
                </div>

                <button type="submit" class="submit-btn">Zapisz</button>
            </form>
        </div>
    </div>
</div>

<script>
    // Dopasowane do backendu
    const EVENT = {
        DELIVERY: 'DELIVERY',
        TRANSFER: 'TRANSFER',
        RETURN: 'RETURN',
        USED: 'USED',
        LOST: 'LOST',
        DELETE: 'DELETE',
        TRANSFER_CAR_TO_CAR: 'TRANSFER_CAR_TO_CAR'
    };

    const LOC = {
        WAREHOUSE: 'WAREHOUSE',
        CAR: 'CAR',
        TASK: 'TASK'
    };

    const el = id => document.getElementById(id);
    const hasValue = v => v !== null && v !== undefined && v !== '';

    function setVisible(groupEl, controlEl, visible) {
        if (!groupEl) return;
        groupEl.classList.toggle('hidden', !visible);
        if (controlEl) {
            controlEl.disabled = !visible;
        }
    }

    function lockType(selectEl, lockedValue) {
        if (!selectEl) return;
        selectEl.value = lockedValue;
        selectEl.setAttribute('data-locked', 'true');
        selectEl.disabled = true;
    }
    function unlockType(selectEl) {
        if (!selectEl) return;
        selectEl.removeAttribute('data-locked');
        selectEl.disabled = false;
    }

    function updateFromSide() {
        const ft = el('fromType').value;
        setVisible(el('grp-fromCar'),  el('fromCar'),  ft === LOC.CAR);
        setVisible(el('grp-fromTask'), el('fromTask'), ft === LOC.TASK);
        if (ft === '' || ft === LOC.WAREHOUSE) {
            setVisible(el('grp-fromCar'),  el('fromCar'),  false);
            setVisible(el('grp-fromTask'), el('fromTask'), false);
        }
    }

    function updateToSide() {
        const tt = el('toType').value;
        setVisible(el('grp-toCar'),  el('toCar'),  tt === LOC.CAR);
        setVisible(el('grp-toTask'), el('toTask'), tt === LOC.TASK);
        if (tt === '' || tt === LOC.WAREHOUSE) {
            setVisible(el('grp-toCar'),  el('toCar'),  false);
            setVisible(el('grp-toTask'), el('toTask'), false);
        }
    }

    function hideAllLocation() {
        // odblokuj przed ukryciem (żeby można było ustawić wartości wg trybu)
        unlockType(el('fromType'));
        unlockType(el('toType'));

        setVisible(el('grp-fromType'), el('fromType'), false);
        setVisible(el('grp-fromCar'),  el('fromCar'),  false);
        setVisible(el('grp-fromTask'), el('fromTask'), false);

        setVisible(el('grp-toType'),   el('toType'),   false);
        setVisible(el('grp-toCar'),    el('toCar'),    false);
        setVisible(el('grp-toTask'),   el('toTask'),   false);
    }

    function updateUI() {
        const type = el('eventType').value;

        // Cena jednostkowa: sens głównie przy DELIVERY
        setVisible(el('grp-unitPrice'), el('unitPrice'), type === EVENT.DELIVERY);

        hideAllLocation();

        switch (type) {
            case EVENT.DELIVERY:
                // przyjęcie do magazynu (TO=WAREHOUSE), bez kodów
                lockType(el('toType'), LOC.WAREHOUSE);
                setVisible(el('grp-toType'), el('toType'), true);
                updateToSide();
                // FROM nieużywany
                break;

            case EVENT.TRANSFER:
                // na sztywno: WAREHOUSE -> CAR
                lockType(el('fromType'), LOC.WAREHOUSE);
                lockType(el('toType'),   LOC.CAR);
                setVisible(el('grp-fromType'), el('fromType'), true);
                setVisible(el('grp-toType'),   el('toType'),   true);
                updateFromSide(); // schowa kody FROM
                updateToSide();   // pokaże wybór auta docelowego
                break;

            case EVENT.RETURN:
                // na sztywno: CAR -> WAREHOUSE
                lockType(el('fromType'), LOC.CAR);
                lockType(el('toType'),   LOC.WAREHOUSE);
                setVisible(el('grp-fromType'), el('fromType'), true);
                setVisible(el('grp-toType'),   el('toType'),   true);
                updateFromSide(); // pokaże wybór auta źródłowego
                updateToSide();   // schowa kody TO
                break;

            case EVENT.TRANSFER_CAR_TO_CAR:
                // na sztywno: CAR -> CAR (od razu pokaż oba auta)
                lockType(el('fromType'), LOC.CAR);
                lockType(el('toType'),   LOC.CAR);
                setVisible(el('grp-fromType'), el('fromType'), true);
                setVisible(el('grp-toType'),   el('toType'),   true);
                updateFromSide(); // pokaże fromCar
                updateToSide();   // pokaże toCar
                break;

            case EVENT.USED:
            case EVENT.LOST:
            case EVENT.DELETE:
                // tylko FROM, można wybrać CAR/TASK/WAREHOUSE; TASK widoczny tylko gdy FROM=TASK
                setVisible(el('grp-fromType'), el('fromType'), true);
                updateFromSide();
                // TO nieużywany
                break;

            default:
                // domyślnie nic poza typem
                break;
        }
    }

    function validateBeforeSubmit(e) {
        const type = el('eventType').value;
        const fromType = el('fromType').value;
        const toType   = el('toType').value;

        if (!type) {
            e.preventDefault();
            alert('Wybierz typ zdarzenia.');
            return false;
        }

        const needFrom = [EVENT.RETURN, EVENT.USED, EVENT.LOST, EVENT.DELETE, EVENT.TRANSFER, EVENT.TRANSFER_CAR_TO_CAR].includes(type);
        const needTo   = [EVENT.TRANSFER, EVENT.RETURN, EVENT.TRANSFER_CAR_TO_CAR, EVENT.DELIVERY].includes(type);

        if (needFrom && !fromType) {
            e.preventDefault();
            alert('Wybierz źródło (From).');
            return false;
        }
        if (needTo && !toType) {
            e.preventDefault();
            alert('Wybierz cel (To).');
            return false;
        }

        // Kody lokalizacji gdy wymagane
        if (fromType === LOC.CAR && el('fromCar').disabled === false && !el('fromCar').value) {
            e.preventDefault();
            alert('Wybierz auto źródłowe.');
            return false;
        }
        if (fromType === LOC.TASK && el('fromTask').disabled === false && !el('fromTask').value) {
            e.preventDefault();
            alert('Wybierz zadanie źródłowe.');
            return false;
        }
        if (toType === LOC.CAR && el('toCar').disabled === false && !el('toCar').value) {
            e.preventDefault();
            alert('Wybierz auto docelowe.');
            return false;
        }
        if (toType === LOC.TASK && el('toTask').disabled === false && !el('toTask').value) {
            e.preventDefault();
            alert('Wybierz zadanie docelowe.');
            return false;
        }

        if (type === EVENT.TRANSFER_CAR_TO_CAR
            && fromType === LOC.CAR && toType === LOC.CAR
            && hasValue(el('fromCar').value) && el('fromCar').value === el('toCar').value) {
            e.preventDefault();
            alert('Auto źródłowe i docelowe nie mogą być takie same.');
            return false;
        }
        return true;
    }

    document.addEventListener('DOMContentLoaded', () => {
        el('eventType').addEventListener('change', updateUI);
        el('fromType').addEventListener('change', updateFromSide);
        el('toType').addEventListener('change', updateToSide);
        el('eventForm').addEventListener('submit', validateBeforeSubmit);

        updateUI();
    });
</script>
</body>
</html>